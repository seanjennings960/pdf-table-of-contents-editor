# Edit PDF Table of Contents

This document summarizes a Linux workflow for updating PDF table
of contents. The process is broken into 4 steps:
1. generate table of contents text file with pdf-contents-extractor,
2. manually edit generated contents file,
3. run apply-offsets script, and
4. update with HandyOutliner tool

## Install

### HandyOutliner
Download the package from [here](https://handyoutlinerfo.sourceforge.net/) and
then install the necessary dependencies:
```bash
sudo apt-get install mono-complete djvulibre-bin
```

### pdf-contents-extractor
This is just a pip python [package](https://pypi.org/project/document-contents-extractor/). Install in a virtualenv with:

```bash
PDF_EXTRACTOR_DIR="$(pwd)"
python3 -m virtualenv venv
source venv/bin/activate
pip3 install document-contents-extractor

cd ~/bin/
ln -s $PDF_EXTRACTOR_DIR/venv/bin/extract_contents extract_contents
```

## Workflow
### Extract Contents
Find the table of contents page in the PDF and note the first and last
page to use in the following command:

```bash
extract_contents filename firstpage lastpage
```

This will generate a `contents.txt` file (there might be some errors, but it still
works regardless...)

### Manually edit contents file
The OCR from the previous step is not perfect. Make sure that:
* Characters are all read correctly.
* Each "bookmark" is on its own line and has a page number.
* Preceeding tabs represent the heirarchy
* Any pages with roman numerals are converted to the raw pdf page

### Run apply-offsets script
The "offset" is the number of raw pdf pages before the marked "Page 1".
Pass the path to `contents.txt`, the offset, and the index of the first
bookmark for which the offset should be applied.
```bash
python3 apply-offset.py contents.txt -n $OFFSET -s $START
```

### HandyOutliner
Run the following command in a directory containing both the contents.txt file
and the PDF:
```bash
mono $PATH_TO_HANDY_OUTLINER_INSTALL/HandyOutliner.exe
```
Open the `contents_out.txt` file generated by the `apply-offsets.py` script
and verify the contents has been read correctly.

Then, select the PDF file and click "Write Outline" to write the table of contents
to the PDF file.

Repeat steps 2-4 as necessary to get the desired contents output.